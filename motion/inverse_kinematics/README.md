# 로봇팔 역기구학 제어 시스템 (Arduino)

## 개요
이 프로젝트는 3링크 로봇팔의 역기구학을 계산하여 목표 위치에 도달할 수 있도록 서보 모터를 제어하는 Arduino 시스템입니다.

## 하드웨어 구성
- **베이스**: 고정, 회전 안함
- **어깨 관절**: 서보 1 (pitch 방향)
- **팔꿈치 관절**: 서보 2 (pitch 방향)  
- **엔드 이펙터**: 그리퍼 또는 도구

## 물리적 사양
```
L1 = 95.0mm  : 베이스 → 어깨 관절 높이
L2 = 123.0mm : 어깨 관절 → 팔꿈치 관절 링크 길이
L3 = 200.0mm : 팔꿈치 관절 → 엔드 이펙터 링크 길이
```

## 코드 구조 분석

### 1. 라이브러리 및 초기화
```cpp
#include <Wire.h>                    // I2C 통신
#include <Adafruit_PWMServoDriver.h> // PWM 서보 드라이버 제어
#include <math.h>                    // 수학 함수
```

### 2. 서보 모터 설정
- **PCA9685 PWM 드라이버** 사용 (최대 16채널)
- **PWM 범위**: 150~500 (안전한 동작 범위)
- **주파수**: 50Hz (표준 서보 모터 동작 주파수)

#### 서보 모터별 상세 설정
```cpp
ServoConfig servos[numServos] = {
    {375, 150, 500, -90, 90, 0},  // 서보 0: 베이스 (yaw, 현재 사용 안함)
    {440, 150, 500, -90, 90, 0},  // 서보 1: 어깨 (pitch) - 수평 위치: 440
    {450, 150, 500, -90, 90, 0},  // 서보 2: 팔꿈치 (pitch) - 수평 위치: 450
    // ... 서보 3-5: 향후 확장용
};
```

### 3. 좌표계 및 변수
- **Y축**: 전후 방향 (양수 = 앞쪽, 음수 = 뒤쪽)
- **Z축**: 상하 방향 (양수 = 위쪽, 음수 = 아래쪽)
- **X축**: 항상 0 (2D 평면에서 동작)

#### 주요 전역 변수
```cpp
float targetY = 0.0;  // 목표 Y 좌표 (mm)
float targetZ = 0.0;  // 목표 Z 좌표 (mm)
float theta1 = 0.0;   // 베이스 회전 각도 (항상 0도)
float theta2 = 0.0;   // 어깨 관절 각도 (서보 1)
float theta3 = 0.0;   // 팔꿈치 관절 각도 (서보 2)
```

### 4. 핵심 함수들

#### 4.1 `setup()`
- 시리얼 통신 초기화 (9600 baud)
- PWM 서보 드라이버 초기화 (50Hz)
- 사용자 인터페이스 및 도움말 출력
- 홈 포지션으로 초기 이동

#### 4.2 `loop()`
- 시리얼 입력 처리
- 사용자 명령 실행

#### 4.3 `serialEvent()`
- 시리얼 통신 이벤트 핸들러
- 사용자 입력을 버퍼에 저장
- Enter 키 감지 시 처리 완료 플래그 설정

#### 4.4 `processSerialInput()`
- 사용자 입력 명령 처리
- 지원 명령어:
  - `home`: 홈 포지션으로 이동
  - `stop`: 모든 서보 정지
  - `sweep1/2`: 서보 스윕 테스트
  - `test1,100`: PWM 테스트
  - `angle1,30`: 각도 제어
  - 숫자 입력: Y값만 입력 (Z는 100mm로 고정)

#### 4.5 `calculateInverseKinematics(float y, float z)`
- **핵심 알고리즘**: 2D 평면에서의 역기구학 계산
- **계산 과정**:
  1. 도달 가능한 범위 확인 (L2 + L3)
  2. 두 가지 해 계산 (elbow-down과 elbow-up)
  3. theta2가 양수인 해 선택
  4. 각도 오프셋 적용

#### 4.6 `moveRobotArm()`
- 계산된 각도를 PWM 값으로 변환
- 서보 모터 제어 실행
- PWM 범위 경고 출력

#### 4.7 `moveToHomePosition()`
- 안전한 홈 포지션으로 이동
- theta2 = 90도 (수평), theta3 = 0도 (수평)

### 5. 테스트 및 디버깅 함수

#### 5.1 `testAngle(String input)`
- 개별 서보 모터 각도 제어
- 정기구학 계산으로 현재 위치 확인

#### 5.2 `testPWM(String input)`
- PWM 값 직접 테스트
- 안전 확인 후 적용

#### 5.3 `sweepTest(int servoIndex)`
- 서보 모터 전체 범위 테스트
- 100~600 PWM 범위에서 50씩 증가하며 테스트

#### 5.4 `stopAllServos()`
- 모든 서보 모터 비상 정지

## 사용법

### 기본 사용법
1. **Y값만 입력**: `100` (Z는 자동으로 100mm로 설정)
2. **홈 포지션**: `home`
3. **비상 정지**: `stop`

### 고급 사용법
1. **각도 제어**: `angle1,30` (서보 1을 30도로)
2. **PWM 테스트**: `test1,100` (서보 1을 PWM 100으로)
3. **스윕 테스트**: `sweep1` (서보 1 전체 범위 테스트)

## 각도 시스템

### theta2 (어깨 관절)
- **0도**: Y축 수평 (PWM: 230) - 팔이 오른쪽으로 뻗음
- **90도**: Z축 수평 (PWM: 440) - 팔이 위로 뻗음
- **양수**: 반시계방향 회전 (PWM 증가)

### theta3 (팔꿈치 관절)
- **0도**: 쭉 뻗음 (PWM: 450) - 팔꿈치 펴짐
- **90도**: 접힘 (PWM: 240) - 팔꿈치 접힘
- **양수**: 반시계방향 회전 (PWM 감소)

## 안전 기능
- PWM 범위 제한 (150~500)
- 도달 불가능한 위치 감지
- 비상 정지 기능
- 각도 범위 경고

## 확장 가능성
- 베이스 yaw 모터 추가 (서보 0)
- 추가 관절 및 링크 확장
- 그리퍼 제어 기능
- 자동화된 동작 시퀀스

## 주의사항
- 실제 하드웨어에 맞게 PWM 값 조정 필요
- 서보 모터 물리적 한계 고려
- 안전한 동작 범위 내에서 사용
- 정기적인 하드웨어 점검 권장 