<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â™” ì²´ìŠ¤ ë¡œë´‡ - Stockfishì™€ ëŒ€ì „</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .game-setup {
            background: #f8f9fa;
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
        }

        .setup-options {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .option-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .option-group label {
            font-weight: bold;
            color: #495057;
        }

        .option-group select,
        .option-group input {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            transition: border-color 0.3s;
        }

        .option-group select:focus,
        .option-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .start-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 25px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            margin-top: 20px;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .game-board {
            padding: 30px;
            display: flex;
            gap: 30px;
            align-items: flex-start;
            justify-content: center;
            flex-wrap: wrap;
        }

        .chess-board {
            width: 400px;
            height: 400px;
            border: 3px solid #2c3e50;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .board-row {
            display: flex;
            height: 50px;
        }

        .board-square {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }

        .board-square.white {
            background-color: #f0d9b5;
        }

        .board-square.black {
            background-color: #b58863;
        }

        .board-square.selected {
            background-color: #7b61ff !important;
            color: white;
        }

        .board-square.legal-move {
            background-color: #90EE90 !important;
        }

        .board-square.legal-move::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: rgba(0, 255, 0, 0.5);
        }

        .game-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            min-width: 300px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .info-section {
            margin-bottom: 20px;
        }

        .info-section h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .status {
            font-size: 18px;
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
        }

        .move-history {
            max-height: 200px;
            overflow-y: auto;
            background: white;
        }

        /* ë¡œê·¸ ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ€ì¼ */
        .log-container {
            max-height: 200px;
            overflow-y: auto;
            background: #1e1e1e;
            color: #ffffff;
            padding: 10px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 10px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-time {
            color: #888;
            margin-right: 8px;
        }

        .log-info { color: #87CEEB; }
        .log-success { color: #90EE90; }
        .log-warning { color: #FFD700; }
        .log-error { color: #FF6B6B; }
        .log-data { color: #FFA500; }

        .move-item {
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #dee2e6;
        }

        .move-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #f1f3f4;
        }

        .move-item:last-child {
            border-bottom: none;
        }

        .move-number {
            font-weight: bold;
            color: #667eea;
        }

        .controls {
            text-align: center;
            margin-top: 20px;
        }

        .control-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .control-btn:hover {
            background: #5a6268;
        }

        .control-btn.primary {
            background: #28a745;
        }

        .control-btn.primary:hover {
            background: #218838;
        }

        .hidden {
            display: none;
        }

        .game-over {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-top: 20px;
        }

        .game-over h2 {
            margin-bottom: 10px;
        }

        /* íƒ€ì´ë¨¸ ìŠ¤íƒ€ì¼ */
        .timer-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }

        .timer-player {
            text-align: center;
            flex: 1;
        }

        .player-label {
            font-size: 14px;
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }

        .timer-display {
            font-size: 24px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }

        /* í°ìƒ‰ íƒ€ì´ë¨¸ */
        #whiteTimer {
            background: #f0d9b5;
            border-color: #b58863;
            color: #2c3e50;
        }

        /* ê²€ì€ìƒ‰ íƒ€ì´ë¨¸ */
        #blackTimer {
            background: #b58863;
            border-color: #2c3e50;
            color: #f0d9b5;
        }

        .timer-display.warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .timer-display.danger {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }

        /* FEN í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .fen-display {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            word-break: break-all;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .fen-display code {
            background: transparent;
            color: #3498db;
            font-weight: bold;
        }

        .fen-info {
            text-align: center;
            color: #7f8c8d;
            font-size: 11px;
        }

        /* ì¢Œí‘œ ì…ë ¥ ìŠ¤íƒ€ì¼ */
        .coordinate-input {
            margin-bottom: 15px;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .coord-input {
            width: 60px;
            padding: 8px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            text-transform: lowercase;
        }

        .coord-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .arrow {
            font-size: 18px;
            color: #667eea;
            font-weight: bold;
        }

        .promotion-select {
            padding: 8px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            background: white;
            font-size: 12px;
        }

        .convert-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.3s;
        }

        .convert-btn:hover {
            transform: translateY(-2px);
        }

        .san-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            min-height: 20px;
        }

        .san-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .san-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info-text {
            text-align: center;
            margin: 10px 0;
            color: #667eea;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .chess-board {
                width: 320px;
                height: 320px;
            }

            .board-square {
                width: 40px;
                height: 40px;
                font-size: 24px;
            }

            .setup-options {
                flex-direction: column;
                gap: 20px;
            }

            .game-board {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>â™” ì²´ìŠ¤ ë¡œë´‡</h1>
            <p>Stockfishì™€ ëŒ€ì „í•˜ëŠ” ì²´ìŠ¤ ê²Œì„</p>
        </div>

        <div class="game-setup" id="gameSetup">
            <h2>ê²Œì„ ì„¤ì •</h2>
            <div class="setup-options">
                <div class="option-group">
                    <label for="playerColor">ë‚´ ìƒ‰ìƒ ì„ íƒ:</label>
                    <select id="playerColor">
                        <option value="white">í°ìƒ‰ (ì„ ìˆ˜)</option>
                        <option value="black">ê²€ì€ìƒ‰ (í›„ìˆ˜)</option>
                    </select>
                </div>
                <div class="option-group">
                    <label for="difficulty">ë‚œì´ë„:</label>
                    <select id="difficulty">
                        <option value="5">ì´ˆê¸‰ (5)</option>
                        <option value="10" selected>ì¤‘ê¸‰ (10)</option>
                        <option value="15">ê³ ê¸‰ (15)</option>
                        <option value="20">ì „ë¬¸ê°€ (20)</option>
                    </select>
                </div>
            </div>
            <button class="start-btn" onclick="startNewGame()">ê²Œì„ ì‹œì‘</button>
        </div>

        <div class="game-board hidden" id="gameBoard">
            <div class="chess-board" id="chessBoard">
                <!-- ì²´ìŠ¤ë³´ë“œê°€ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>

            <div class="game-info">
                <div class="info-section">
                    <h3>ê²Œì„ ìƒíƒœ</h3>
                    <div class="status" id="gameStatus">ê²Œì„ ì¤€ë¹„ ì¤‘...</div>
                </div>

                <div class="info-section">
                    <h3>ìˆ˜ ìˆœì„œ</h3>
                    <div id="currentTurn">í°ìƒ‰ ì°¨ë¡€</div>
                </div>

                <div class="info-section">
                    <h3>ìŠ¹ë¦¬ ê°€ëŠ¥ì„±</h3>
                    <div id="winProbability">ê³„ì‚° ì¤‘...</div>
                </div>

                <div class="info-section">
                    <h3>íƒ€ì´ë¨¸</h3>
                    <div class="timer-container">
                        <div class="timer-player">
                            <div class="player-label">ê²€ì€ìƒ‰</div>
                            <div class="timer-display" id="blackTimer">10:00</div>
                        </div>
                        <div class="timer-player">
                            <div class="player-label">í°ìƒ‰</div>
                            <div class="timer-display" id="whiteTimer">10:00</div>
                        </div>
                    </div>
                </div>

                <div class="info-section">
                    <h3>ìˆ˜ ê¸°ë¡</h3>
                    <div class="move-history" id="moveHistory">
                        <div class="move-item">
                            <span>ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš”</span>
                        </div>
                    </div>
                </div>

                <div class="controls">
                    <button class="control-btn" onclick="resetGame()">ìƒˆ ê²Œì„</button>
                    <button class="control-btn primary" onclick="undoMove()">ë¬´ë¥´ê¸°</button>
                    <button class="control-btn" onclick="startArduinoTimer()" id="arduinoTimerBtn" disabled>ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸
                        ì‹œì‘</button>
                </div>

                <div class="info-section">
                    <h3>ì¢Œí‘œ ì…ë ¥ (ìë™ ë°©í–¥ ê°ì§€)</h3>
                    <div class="coordinate-input">
                        <div class="input-group">
                            <input type="text" id="fromCoord" placeholder="ì¢Œí‘œ 1 (ì˜ˆ: e2)" maxlength="2"
                                class="coord-input">
                            <span class="arrow">â†”</span>
                            <input type="text" id="toCoord" placeholder="ì¢Œí‘œ 2 (ì˜ˆ: e4)" maxlength="2"
                                class="coord-input">
                            <select id="promotionPiece" class="promotion-select">
                                <option value="">ìŠ¹ê¸‰</option>
                                <option value="q">í€¸</option>
                                <option value="r">ë£©</option>
                                <option value="b">ë¹„ìˆ</option>
                                <option value="n">ë‚˜ì´íŠ¸</option>
                            </select>
                        </div>
                        <button onclick="convertToSAN()" class="convert-btn">SAN ë³€í™˜</button>
                        <div class="info-text">
                            <small>ğŸ’¡ ë‘ ì¢Œí‘œë¥¼ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ì´ë™ ë°©í–¥ì„ ê°ì§€í•©ë‹ˆë‹¤!</small>
                        </div>
                        <div id="sanResult" class="san-result"></div>
                    </div>
                </div>

                <div class="info-section">
                    <h3>FEN í‘œê¸°ë²•</h3>
                    <div class="fen-display" id="fenDisplay">
                        <code>rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1</code>
                    </div>
                    <div class="fen-info">
                        <small>FEN: Forsyth-Edwards Notation - ì²´ìŠ¤ë³´ë“œì˜ í˜„ì¬ ìƒíƒœë¥¼ í‘œì¤€ í˜•ì‹ìœ¼ë¡œ í‘œí˜„</small>
                    </div>
                </div>

                <div class="game-over hidden" id="gameOver">
                    <h2>ê²Œì„ ì¢…ë£Œ!</h2>
                    <div id="gameResult"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentGame = null;
        let selectedSquare = null;
        let legalMoves = [];

        // íƒ€ì´ë¨¸ ê´€ë ¨ ë³€ìˆ˜
        let whiteTimer = 600; // 10ë¶„ = 600ì´ˆ
        let blackTimer = 600;
        let timerInterval = null;
        let websocket = null; // WebSocket ì—°ê²°

        // Socket.IO ì—°ê²° ì„¤ì •
        function connectWebSocket() {
            try {
                // Socket.IO í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
                const socket = io();

                socket.on('connect', function () {
                    console.log('Socket.IO ì—°ê²° ì„±ê³µ');
                    websocket = socket;

                    // ì—°ê²° ì„±ê³µ ì‹œ ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ ë²„íŠ¼ í™œì„±í™”
                    const btn = document.getElementById('arduinoTimerBtn');
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = 'ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ ì‹œì‘';
                        btn.style.background = '';
                    }
                });

                socket.on('timer_data', function (data) {
                    console.log('íƒ€ì´ë¨¸ ë°ì´í„° ìˆ˜ì‹ :', data);

                    // P1:ì‹œê°„,P2:ì‹œê°„ í˜•ì‹ íŒŒì‹±
                    if (data.startsWith('P1:') && data.includes(',P2:')) {
                        const parts = data.split(',');
                        if (parts.length === 2) {
                            try {
                                const p1Time = parseInt(parts[0].split(':')[1]);
                                const p2Time = parseInt(parts[1].split(':')[1]);

                                // ì•„ë‘ì´ë…¸ì—ì„œ ë°›ì€ ì‹œê°„ìœ¼ë¡œ íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸
                                updateTimerFromArduino(p1Time, p2Time);
                            } catch (error) {
                                console.error('íƒ€ì´ë¨¸ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', error);
                            }
                        }
                    }
                });

                socket.on('arduino_timer_response', function (data) {
                    console.log('ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ ì‘ë‹µ:', data);

                    if (data.status === 'started') {
                        console.log('ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ ì‹œì‘ë¨');
                    } else if (data.status === 'stopped') {
                        console.log('ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ ì •ì§€ë¨');
                        // ë²„íŠ¼ ìƒíƒœ ë³µì›
                        const btn = document.getElementById('arduinoTimerBtn');
                        if (btn) {
                            btn.textContent = 'ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ ì‹œì‘';
                            btn.disabled = false;
                            btn.style.background = '';
                        }
                    } else if (data.status === 'reset') {
                        console.log('ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ ë¦¬ì…‹ë¨');
                    } else if (data.status === 'error') {
                        console.error('ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ ì˜¤ë¥˜:', data.message);
                        alert('ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ ì˜¤ë¥˜: ' + data.message);
                        // ì˜¤ë¥˜ ì‹œ ë²„íŠ¼ ìƒíƒœ ë³µì›
                        const btn = document.getElementById('arduinoTimerBtn');
                        if (btn) {
                            btn.textContent = 'ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ ì‹œì‘';
                            btn.disabled = false;
                            btn.style.background = '';
                        }
                    }
                });

                socket.on('disconnect', function () {
                    console.log('Socket.IO ì—°ê²° ì¢…ë£Œ');
                    websocket = null;
                    // ì¬ì—°ê²° ì‹œë„
                    setTimeout(connectWebSocket, 3000);
                });

                socket.on('connect_error', function (error) {
                    console.error('Socket.IO ì—°ê²° ì˜¤ë¥˜:', error);
                });

            } catch (error) {
                console.error('Socket.IO ì—°ê²° ì‹¤íŒ¨:', error);
            }
        }

        // ì•„ë‘ì´ë…¸ì—ì„œ ë°›ì€ íƒ€ì´ë¨¸ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
        function updateTimerFromArduino(p1Time, p2Time) {
            // ì•„ë‘ì´ë…¸ì˜ P1ì€ ê²€ì€ìƒ‰, P2ëŠ” í°ìƒ‰ (ì²´ìŠ¤ë³´ë“œ ê¸°ì¤€)
            blackTimer = p1Time;
            whiteTimer = p2Time;

            // íƒ€ì´ë¨¸ í‘œì‹œ ì—…ë°ì´íŠ¸
            updateTimerDisplay();

            console.log(`ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸ - ê²€ì€ìƒ‰: ${blackTimer}ì´ˆ, í°ìƒ‰: ${whiteTimer}ì´ˆ`);
        }

        // ì²´ìŠ¤ ê¸°ë¬¼ ìœ ë‹ˆì½”ë“œ
        const pieces = {
            'white': {
                'P': 'â™™', 'R': 'â™–', 'N': 'â™˜', 'B': 'â™—', 'Q': 'â™•', 'K': 'â™”'
            },
            'black': {
                'P': 'â™Ÿ', 'R': 'â™œ', 'N': 'â™', 'B': 'â™', 'Q': 'â™›', 'K': 'â™š'
            }
        };

        // ì²´ìŠ¤ë³´ë“œ ì´ˆê¸°í™”
        function initializeBoard() {
            const board = document.getElementById('chessBoard');
            board.innerHTML = '';

            for (let row = 0; row < 8; row++) {
                const boardRow = document.createElement('div');
                boardRow.className = 'board-row';

                for (let col = 0; col < 8; col++) {
                    const square = document.createElement('div');
                    const squareIndex = row * 8 + col;
                    const isWhite = (row + col) % 2 === 0;

                    square.className = `board-square ${isWhite ? 'white' : 'black'}`;
                    square.dataset.index = squareIndex;
                    square.onclick = () => handleSquareClick(squareIndex);

                    boardRow.appendChild(square);
                }

                board.appendChild(boardRow);
            }

            // ì´ˆê¸° ê¸°ë¬¼ ë°°ì¹˜
            setupInitialPieces();
        }

        // ì²´ìŠ¤ë³´ë“œ ì—…ë°ì´íŠ¸
        function updateBoard(fen) {
            console.log('FEN ì—…ë°ì´íŠ¸:', fen);
            const parts = fen.split(' ');
            const boardState = parts[0];
            console.log('ë³´ë“œ ìƒíƒœ:', boardState);

            // ëª¨ë“  ì¹¸ ì´ˆê¸°í™”
            const squares = document.querySelectorAll('.board-square');
            squares.forEach(square => {
                square.textContent = '';
                square.dataset.piece = '';
                square.dataset.color = '';
            });

            let squareIndex = 0;
            for (let char of boardState) {
                if (char === '/') continue;

                if (char >= '1' && char <= '8') {
                    squareIndex += parseInt(char);
                } else {
                    const color = char === char.toUpperCase() ? 'white' : 'black';
                    const piece = char.toUpperCase();
                    const square = document.querySelector(`[data-index="${squareIndex}"]`);

                    if (square) {
                        console.log(`ì¹¸ ${squareIndex}: ${color} ${piece}`);
                        square.textContent = pieces[color][piece];
                        square.dataset.piece = piece;
                        square.dataset.color = color;
                    }

                    squareIndex++;
                }
            }

            // ë³´ë“œ ì—…ë°ì´íŠ¸ í›„ FENê³¼ ìŠ¹ë¦¬ ê°€ëŠ¥ì„± ì¬ê³„ì‚°
            updateFEN(fen);
            updateWinProbability();
        }

        // FENì„ ì²´ìŠ¤ë³´ë“œì— ì§ì ‘ ë°°ì¹˜í•˜ëŠ” í•¨ìˆ˜
        function placePiecesFromFen(fen) {
            console.log('FENì—ì„œ ê¸°ë¬¼ ë°°ì¹˜ ì‹œì‘:', fen);

            // ëª¨ë“  ì¹¸ ì´ˆê¸°í™”
            const squares = document.querySelectorAll('.board-square');
            squares.forEach(square => {
                square.textContent = '';
                square.dataset.piece = '';
                square.dataset.color = '';
            });

            const parts = fen.split(' ');
            const boardState = parts[0];

            let squareIndex = 0;
            for (let char of boardState) {
                if (char === '/') continue;

                if (char >= '1' && char <= '8') {
                    squareIndex += parseInt(char);
                } else {
                    const color = char === char.toUpperCase() ? 'white' : 'black';
                    const piece = char.toUpperCase();
                    const square = document.querySelector(`[data-index="${squareIndex}"]`);

                    if (square) {
                        console.log(`FEN ë°°ì¹˜ - ì¹¸ ${squareIndex}: ${color} ${piece}`);
                        square.textContent = pieces[color][piece];
                        square.dataset.piece = piece;
                        square.dataset.color = color;
                    }

                    squareIndex++;
                }
            }

            console.log('FENì—ì„œ ê¸°ë¬¼ ë°°ì¹˜ ì™„ë£Œ');

            // ê¸°ë¬¼ ë°°ì¹˜ í›„ ìŠ¹ë¦¬ ê°€ëŠ¥ì„± ê³„ì‚°
            updateWinProbability();
        }

        // ì´ˆê¸° ê¸°ë¬¼ ë°°ì¹˜ í•¨ìˆ˜
        function setupInitialPieces() {
            console.log('ì´ˆê¸° ê¸°ë¬¼ ë°°ì¹˜ ì‹œì‘');

            // ì´ˆê¸° ì²´ìŠ¤ ê¸°ë¬¼ ë°°ì¹˜ (8x8 ë°°ì—´)
            const initialBoard = [
                ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r'],  // 8ë²ˆì§¸ ì¤„ (ê²€ì€ìƒ‰)
                ['p', 'p', 'p', 'p', 'p', 'p', 'p', 'p'],  // 7ë²ˆì§¸ ì¤„ (ê²€ì€ìƒ‰ í°)
                ['', '', '', '', '', '', '', ''],            // 6ë²ˆì§¸ ì¤„ (ë¹ˆì¹¸)
                ['', '', '', '', '', '', '', ''],            // 5ë²ˆì§¸ ì¤„ (ë¹ˆì¹¸)
                ['', '', '', '', '', '', '', ''],            // 4ë²ˆì§¸ ì¤„ (ë¹ˆì¹¸)
                ['', '', '', '', '', '', '', ''],            // 3ë²ˆì§¸ ì¤„ (ë¹ˆì¹¸)
                ['P', 'P', 'P', 'P', 'P', 'P', 'P', 'P'],  // 2ë²ˆì§¸ ì¤„ (í°ìƒ‰ í°)
                ['R', 'N', 'B', 'Q', 'K', 'B', 'N', 'R']   // 1ë²ˆì§¸ ì¤„ (í°ìƒ‰)
            ];

            // ê° ì¹¸ì— ê¸°ë¬¼ ë°°ì¹˜
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const squareIndex = row * 8 + col;
                    const piece = initialBoard[row][col];
                    const square = document.querySelector(`[data-index="${squareIndex}"]`);

                    if (square && piece !== '') {
                        const color = piece === piece.toUpperCase() ? 'white' : 'black';
                        const pieceType = piece.toUpperCase();

                        console.log(`ì¹¸ ${squareIndex} (${row},${col}): ${color} ${pieceType}`);
                        square.textContent = pieces[color][pieceType];
                        square.dataset.piece = pieceType;
                        square.dataset.color = color;
                    }
                }
            }

            console.log('ì´ˆê¸° ê¸°ë¬¼ ë°°ì¹˜ ì™„ë£Œ');
        }

        // ìƒˆ ê²Œì„ ì‹œì‘
        function startNewGame() {
            const playerColor = document.getElementById('playerColor').value;
            const difficulty = document.getElementById('difficulty').value;

            fetch('/new_game', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    player_color: playerColor,
                    difficulty: parseInt(difficulty)
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentGame = data.game_id;
                        document.getElementById('gameSetup').classList.add('hidden');
                        document.getElementById('gameBoard').classList.remove('hidden');
                        document.getElementById('gameOver').classList.add('hidden');

                        updateGameState(data.board_state);
                        placePiecesFromFen(data.board_state.fen);

                        // WebSocket ì—°ê²° ì‹œì‘
                        connectWebSocket();

                        // WebSocket ì—°ê²° í›„ ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ ì‹œì‘
                        setTimeout(() => {
                            if (websocket && websocket.connected) {
                                startArduinoTimer();
                                console.log('ê²Œì„ ì‹œì‘ë¨ - ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ ìë™ ì‹œì‘');
                            } else {
                                console.log('WebSocket ì—°ê²° ëŒ€ê¸° ì¤‘...');
                                // ì—°ê²°ì´ ì•ˆ ë˜ë©´ 3ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„
                                setTimeout(() => {
                                    if (websocket && websocket.connected) {
                                        startArduinoTimer();
                                        console.log('ê²Œì„ ì‹œì‘ë¨ - ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ ì‹œì‘ (ì§€ì—°)');
                                    } else {
                                        console.log('WebSocket ì—°ê²° ì‹¤íŒ¨');
                                    }
                                }, 3000);
                            }
                        }, 1000);
                    }
                })
                .catch(error => {
                    console.error('ê²Œì„ ì‹œì‘ ì˜¤ë¥˜:', error);
                    alert('ê²Œì„ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                });
        }

        // ê²Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateGameState(boardState) {
            const gameStatusDiv = document.getElementById('gameStatus');
            const currentTurnDiv = document.getElementById('currentTurn');

            if (boardState.game_over) {
                // ê²Œì„ ì¢…ë£Œ ì‹œ íƒ€ì´ë¨¸ ì •ì§€
                stopTimer();

                // ê²Œì„ ì¢…ë£Œ ì´ìœ ì— ë”°ë¥¸ ìƒíƒœ ë©”ì‹œì§€ ìƒì„±
                let statusMessage = '';
                let statusColor = '#e74c3c';

                if (boardState.result === '1-0') {
                    statusMessage = 'ê²Œì„ ì¢…ë£Œ - í°ìƒ‰ ìŠ¹ë¦¬! (ì²´í¬ë©”ì´íŠ¸)';
                    statusColor = '#3498db';
                } else if (boardState.result === '0-1') {
                    statusMessage = 'ê²Œì„ ì¢…ë£Œ - ê²€ì€ìƒ‰ ìŠ¹ë¦¬! (ì²´í¬ë©”ì´íŠ¸)';
                    statusColor = '#2c3e50';
                } else if (boardState.result === '1/2-1/2') {
                    statusMessage = 'ê²Œì„ ì¢…ë£Œ - ë¬´ìŠ¹ë¶€';
                    statusColor = '#95a5a6';
                } else {
                    statusMessage = 'ê²Œì„ ì¢…ë£Œ';
                    statusColor = '#e74c3c';
                }

                gameStatusDiv.textContent = statusMessage;
                gameStatusDiv.style.color = statusColor;
                gameStatusDiv.style.fontWeight = 'bold';

                // ê²Œì„ ì¢…ë£Œ ì‹œ ì°¨ë¡€ í‘œì‹œ ì œê±°
                currentTurnDiv.textContent = '';

                // ê²Œì„ ì¢…ë£Œ ì´ìœ  í‘œì‹œ
                showGameOver(boardState.result);
            } else {
                gameStatusDiv.textContent = 'ê²Œì„ ì§„í–‰ ì¤‘';
                gameStatusDiv.style.color = '#495057';
                gameStatusDiv.style.fontWeight = 'normal';

                currentTurnDiv.textContent =
                    `í˜„ì¬ ì°¨ë¡€: ${boardState.current_turn === 'white' ? 'í°ìƒ‰' : 'ê²€ì€ìƒ‰'}`;
            }

            updateMoveHistory(boardState.move_history);

            // FEN ì—…ë°ì´íŠ¸
            if (boardState.fen) {
                updateFEN(boardState.fen);
            }

            // ìŠ¹ë¦¬ ê°€ëŠ¥ì„± ì—…ë°ì´íŠ¸
            updateWinProbability();
        }

        // ìˆ˜ ê¸°ë¡ ì—…ë°ì´íŠ¸
        function updateMoveHistory(moves) {
            const historyDiv = document.getElementById('moveHistory');
            historyDiv.innerHTML = '';

            if (moves.length === 0) {
                historyDiv.innerHTML = '<div class="move-item"><span>ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš”</span></div>';
                return;
            }

            for (let i = 0; i < moves.length; i += 2) {
                const moveItem = document.createElement('div');
                moveItem.className = 'move-item';

                const moveNumber = Math.floor(i / 2) + 1;
                const whiteMove = moves[i] ? moves[i].move : '';
                const blackMove = moves[i + 1] ? moves[i + 1].move : '';

                moveItem.innerHTML = `
                    <span class="move-number">${moveNumber}.</span>
                    <span>${whiteMove}</span>
                    <span>${blackMove}</span>
                `;

                historyDiv.appendChild(moveItem);
            }
        }

        // ê²Œì„ ì¢…ë£Œ í‘œì‹œ
        function showGameOver(result) {
            const gameOverDiv = document.getElementById('gameOver');
            const resultDiv = document.getElementById('gameResult');

            let resultText = '';
            let resultColor = '';
            let resultDetails = '';
            let additionalInfo = '';

            if (result === '1-0') {
                resultText = 'â™” í°ìƒ‰ ìŠ¹ë¦¬! â™”';
                resultColor = '#3498db';
                resultDetails = 'ì²´í¬ë©”ì´íŠ¸ë¡œ ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                additionalInfo = 'í°ìƒ‰ì´ ê²€ì€ìƒ‰ì˜ í‚¹ì„ ì²´í¬ë©”ì´íŠ¸í–ˆìŠµë‹ˆë‹¤.';
            } else if (result === '0-1') {
                resultText = 'â™š ê²€ì€ìƒ‰ ìŠ¹ë¦¬! â™š';
                resultColor = '#2c3e50';
                resultDetails = 'ì²´í¬ë©”ì´íŠ¸ë¡œ ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                additionalInfo = 'ê²€ì€ìƒ‰ì´ í°ìƒ‰ì˜ í‚¹ì„ ì²´í¬ë©”ì´íŠ¸í–ˆìŠµë‹ˆë‹¤.';
            } else if (result === '1/2-1/2') {
                resultText = 'âš–ï¸ ë¬´ìŠ¹ë¶€! âš–ï¸';
                resultColor = '#95a5a6';
                resultDetails = 'ê²Œì„ì´ ë¬´ìŠ¹ë¶€ë¡œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                additionalInfo = 'ìŠ¤í…Œì¼ë©”ì´íŠ¸, 50ìˆ˜ ê·œì¹™, ê¸°ë¬¼ ë¶€ì¡±, ë°˜ë³µ ë“±ìœ¼ë¡œ ì¸í•œ ë¬´ìŠ¹ë¶€ì…ë‹ˆë‹¤.';
            } else {
                resultText = 'ğŸ ê²Œì„ ì¢…ë£Œ';
                resultColor = '#e74c3c';
                resultDetails = 'ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                additionalInfo = 'ì•Œ ìˆ˜ ì—†ëŠ” ì´ìœ ë¡œ ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
            }

            resultDiv.innerHTML = `
                <div style="font-size: 24px; font-weight: bold; color: ${resultColor}; margin-bottom: 10px;">
                    ${resultText}
                </div>
                <div style="font-size: 14px; color: #7f8c8d; margin-bottom: 8px;">
                    ${resultDetails}
                </div>
                <div style="font-size: 12px; color: #95a5a6; font-style: italic;">
                    ${additionalInfo}
                </div>
            `;

            gameOverDiv.classList.remove('hidden');

            // ê²Œì„ ì¢…ë£Œ ì‹œ íƒ€ì´ë¨¸ ì •ì§€
            stopTimer();

            // ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ë„ ì •ì§€
            stopArduinoTimer();

            // ê²Œì„ ì¢…ë£Œ ì‹œ ì„ íƒëœ ê¸°ë¬¼ê³¼ í•©ë²•ì ì¸ ì´ë™ í‘œì‹œ ì œê±°
            clearSelection();
        }

        // ì¹¸ í´ë¦­ ì²˜ë¦¬
        function handleSquareClick(squareIndex) {
            if (!currentGame) return;

            // ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
            const gameStatus = document.getElementById('gameStatus').textContent;
            if (gameStatus === 'ê²Œì„ ì¢…ë£Œ') {
                alert('ê²Œì„ì´ ì´ë¯¸ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆ ê²Œì„ì„ ì‹œì‘í•´ì£¼ì„¸ìš”.');
                return;
            }

            const square = document.querySelector(`[data-index="${squareIndex}"]`);

            // ì´ë¯¸ ì„ íƒëœ ì¹¸ì´ ìˆëŠ” ê²½ìš°
            if (selectedSquare !== null) {
                // ê°™ì€ ì¹¸ì„ í´ë¦­í•œ ê²½ìš° ì„ íƒ í•´ì œ
                if (selectedSquare === squareIndex) {
                    clearSelection();
                    return;
                }

                // ì´ë™ ì‹œë„
                const fromSquare = selectedSquare;
                const toSquare = squareIndex;

                makeMove(fromSquare, toSquare);
                clearSelection();
                return;
            }

            // ìƒˆë¡œìš´ ì¹¸ ì„ íƒ - í˜„ì¬ ì°¨ë¡€ì¸ ê¸°ë¬¼ë§Œ ì„ íƒ ê°€ëŠ¥
            if (square.dataset.piece) {
                const currentTurn = document.getElementById('currentTurn').textContent;
                const isWhiteTurn = currentTurn.includes('í°ìƒ‰');
                const pieceColor = square.dataset.color;

                // í˜„ì¬ ì°¨ë¡€ì™€ ê¸°ë¬¼ ìƒ‰ìƒì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
                if ((isWhiteTurn && pieceColor === 'white') || (!isWhiteTurn && pieceColor === 'black')) {
                    selectedSquare = squareIndex;
                    square.classList.add('selected');

                    // í•©ë²•ì ì¸ ì´ë™ í‘œì‹œ
                    showLegalMoves(squareIndex);
                } else {
                    // ìƒëŒ€ ì°¨ë¡€ì˜ ê¸°ë¬¼ì„ í´ë¦­í•œ ê²½ìš°
                    alert('í˜„ì¬ëŠ” ë‹¹ì‹ ì˜ ì°¨ë¡€ê°€ ì•„ë‹™ë‹ˆë‹¤.');
                }
            }
        }

        // ì„ íƒ í•´ì œ
        function clearSelection() {
            if (selectedSquare !== null) {
                const square = document.querySelector(`[data-index="${selectedSquare}"]`);
                if (square) {
                    square.classList.remove('selected');
                }
                selectedSquare = null;

                // í•©ë²•ì ì¸ ì´ë™ í‘œì‹œ ì œê±°
                clearLegalMoves();
            }
        }

        // í•©ë²•ì ì¸ ì´ë™ í‘œì‹œ
        function showLegalMoves(squareIndex) {
            // í˜„ì¬ ì„ íƒëœ ê¸°ë¬¼ì˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const selectedSquare = document.querySelector(`[data-index="${squareIndex}"]`);
            if (!selectedSquare || !selectedSquare.dataset.piece) return;

            const selectedColor = selectedSquare.dataset.color;
            const pieceType = selectedSquare.dataset.piece;

            console.log(`ê¸°ë¬¼ ì„ íƒ: ${pieceType} (${selectedColor}) at ${squareIndex}`);

            // ëª¨ë“  ì¹¸ì—ì„œ í•©ë²•ì ì¸ ì´ë™ í‘œì‹œ ì œê±°
            clearLegalMoves();

            console.log(`í˜„ì¬ ì°¨ë¡€: ${document.getElementById('currentTurn').textContent}`);

            // ê°„ë‹¨í•œ ì²´ìŠ¤ ê·œì¹™ ê¸°ë°˜ í•©ë²•ì ì¸ ì´ë™ í‘œì‹œ
            const squares = document.querySelectorAll('.board-square');
            let legalMoveCount = 0;

            squares.forEach(square => {
                const targetIndex = parseInt(square.dataset.index);
                if (targetIndex === squareIndex) return; // ê°™ì€ ì¹¸ì€ ì œì™¸

                const targetPiece = square.dataset.piece;
                const targetColor = square.dataset.color;

                // ìƒëŒ€ ê¸°ë¬¼ì´ ìˆëŠ” ì¹¸ì€ ê¸°ë¬¼ ì¡ê¸° ê°€ëŠ¥
                if (targetPiece && targetColor !== selectedColor) {
                    if (isValidCapture(squareIndex, targetIndex, pieceType, selectedColor)) {
                        square.classList.add('legal-move');
                        legalMoveCount++;
                        console.log(`ê¸°ë¬¼ ì¡ê¸° ê°€ëŠ¥: ${targetIndex} (${targetPiece})`);
                    } else {
                        console.log(`ê¸°ë¬¼ ì¡ê¸° ë¶ˆê°€: ${targetIndex} (${targetPiece}) - ${pieceType}ìœ¼ë¡œëŠ” ì¡ì„ ìˆ˜ ì—†ìŒ`);
                    }
                }
                // ë¹ˆ ì¹¸ì€ ì´ë™ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
                else if (!targetPiece) {
                    if (isValidMove(squareIndex, targetIndex, pieceType, selectedColor)) {
                        square.classList.add('legal-move');
                        legalMoveCount++;
                        console.log(`ì´ë™ ê°€ëŠ¥: ${targetIndex}`);
                    } else {
                        console.log(`ì´ë™ ë¶ˆê°€: ${targetIndex} - ${pieceType}ìœ¼ë¡œëŠ” ì´ë™í•  ìˆ˜ ì—†ìŒ`);
                    }
                }
            });

            console.log(`ì´ ${legalMoveCount}ê°œì˜ í•©ë²•ì ì¸ ì´ë™ ë°œê²¬`);
        }

        // ì •í™•í•œ ì²´ìŠ¤ ì´ë™ ìœ íš¨ì„± ê²€ì‚¬
        function isValidMove(fromIndex, toIndex, pieceType, color) {
            const fromRow = Math.floor(fromIndex / 8);
            const fromCol = fromIndex % 8;
            const toRow = Math.floor(toIndex / 8);
            const toCol = toIndex % 8;

            // í° ì´ë™ ê·œì¹™
            if (pieceType === 'P') {
                const direction = color === 'white' ? -1 : 1;
                const startRow = color === 'white' ? 6 : 1;

                // ìˆ˜ì§ ì´ë™
                if (fromCol === toCol) {
                    // í•œ ì¹¸ ì´ë™
                    if (toRow === fromRow + direction) {
                        return !hasPieceAt(toIndex);
                    }
                    // ë‘ ì¹¸ ì´ë™ (ì‹œì‘ ìœ„ì¹˜ì—ì„œë§Œ)
                    if (fromRow === startRow && toRow === fromRow + 2 * direction) {
                        const middleRow = fromRow + direction;
                        return !hasPieceAt(middleRow * 8 + fromCol) && !hasPieceAt(toIndex);
                    }
                }
                return false;
            }

            // ë£© ì´ë™ ê·œì¹™ (ìˆ˜ì§/ìˆ˜í‰)
            if (pieceType === 'R') {
                if (fromRow !== toRow && fromCol !== toCol) return false;
                return !hasObstacleBetween(fromIndex, toIndex);
            }

            // ë¹„ìˆ ì´ë™ ê·œì¹™ (ëŒ€ê°ì„ )
            if (pieceType === 'B') {
                if (Math.abs(fromRow - toRow) !== Math.abs(fromCol - toCol)) return false;
                return !hasObstacleBetween(fromIndex, toIndex);
            }

            // ë‚˜ì´íŠ¸ ì´ë™ ê·œì¹™ (Lì)
            if (pieceType === 'N') {
                const rowDiff = Math.abs(fromRow - toRow);
                const colDiff = Math.abs(fromCol - toCol);
                const isValid = (rowDiff === 2 && colDiff === 1) || (rowDiff === 1 && colDiff === 2);
                console.log(`ë‚˜ì´íŠ¸ ì´ë™ ê²€ì‚¬: ${fromIndex} -> ${toIndex}, rowDiff: ${rowDiff}, colDiff: ${colDiff}, ìœ íš¨: ${isValid}`);
                return isValid;
            }

            // í€¸ ì´ë™ ê·œì¹™ (ë£© + ë¹„ìˆ)
            if (pieceType === 'Q') {
                if (fromRow === toRow || fromCol === toCol) {
                    return !hasObstacleBetween(fromIndex, toIndex);
                }
                if (Math.abs(fromRow - toRow) === Math.abs(fromCol - toCol)) {
                    return !hasObstacleBetween(fromIndex, toIndex);
                }
                return false;
            }

            // í‚¹ ì´ë™ ê·œì¹™ (í•œ ì¹¸)
            if (pieceType === 'K') {
                return Math.abs(fromRow - toRow) <= 1 && Math.abs(fromCol - toCol) <= 1;
            }

            return false;
        }

        // ë‘ ì¹¸ ì‚¬ì´ì— ì¥ì• ë¬¼ì´ ìˆëŠ”ì§€ í™•ì¸
        function hasObstacleBetween(fromIndex, toIndex) {
            const fromRow = Math.floor(fromIndex / 8);
            const fromCol = fromIndex % 8;
            const toRow = Math.floor(toIndex / 8);
            const toCol = toIndex % 8;

            // ìˆ˜ì§ ì´ë™
            if (fromCol === toCol) {
                const startRow = Math.min(fromRow, toRow);
                const endRow = Math.max(fromRow, toRow);
                for (let row = startRow + 1; row < endRow; row++) {
                    if (hasPieceAt(row * 8 + fromCol)) return true;
                }
            }
            // ìˆ˜í‰ ì´ë™
            else if (fromRow === toRow) {
                const startCol = Math.min(fromCol, toCol);
                const endCol = Math.max(fromCol, toCol);
                for (let col = startCol + 1; col < endCol; col++) {
                    if (hasPieceAt(fromRow * 8 + col)) return true;
                }
            }
            // ëŒ€ê°ì„  ì´ë™
            else {
                const rowStep = fromRow < toRow ? 1 : -1;
                const colStep = fromCol < toCol ? 1 : -1;
                let row = fromRow + rowStep;
                let col = fromCol + colStep;
                while (row !== toRow && col !== toCol) {
                    if (hasPieceAt(row * 8 + col)) return true;
                    row += rowStep;
                    col += colStep;
                }
            }
            return false;
        }

        // ê¸°ë¬¼ ì¡ê¸° ìœ íš¨ì„± ê²€ì‚¬
        function isValidCapture(fromIndex, toIndex, pieceType, color) {
            const fromRow = Math.floor(fromIndex / 8);
            const fromCol = fromIndex % 8;
            const toRow = Math.floor(toIndex / 8);
            const toCol = toIndex % 8;

            // í° ëŒ€ê°ì„  ì´ë™ (ê¸°ë¬¼ ì¡ê¸°)
            if (pieceType === 'P') {
                const direction = color === 'white' ? -1 : 1;
                return Math.abs(toCol - fromCol) === 1 && toRow === fromRow + direction;
            }

            // ë£© ê¸°ë¬¼ ì¡ê¸° (ìˆ˜ì§/ìˆ˜í‰)
            if (pieceType === 'R') {
                if (fromRow !== toRow && fromCol !== toCol) return false;
                return !hasObstacleBetween(fromIndex, toIndex);
            }

            // ë¹„ìˆ ê¸°ë¬¼ ì¡ê¸° (ëŒ€ê°ì„ )
            if (pieceType === 'B') {
                if (Math.abs(fromRow - toRow) !== Math.abs(fromCol - toCol)) return false;
                return !hasObstacleBetween(fromIndex, toIndex);
            }

            // ë‚˜ì´íŠ¸ ê¸°ë¬¼ ì¡ê¸° (Lì)
            if (pieceType === 'N') {
                const rowDiff = Math.abs(fromRow - toRow);
                const colDiff = Math.abs(fromCol - toCol);
                return (rowDiff === 2 && colDiff === 1) || (rowDiff === 1 && colDiff === 2);
            }

            // í€¸ ê¸°ë¬¼ ì¡ê¸° (ë£© + ë¹„ìˆ)
            if (pieceType === 'Q') {
                if (fromRow === toRow || fromCol === toCol) {
                    return !hasObstacleBetween(fromIndex, toIndex);
                }
                if (Math.abs(fromRow - toRow) === Math.abs(fromCol - toCol)) {
                    return !hasObstacleBetween(fromIndex, toIndex);
                }
                return false;
            }

            // í‚¹ ê¸°ë¬¼ ì¡ê¸° (í•œ ì¹¸)
            if (pieceType === 'K') {
                return Math.abs(fromRow - toRow) <= 1 && Math.abs(fromCol - toCol) <= 1;
            }

            return false;
        }

        // íŠ¹ì • ìœ„ì¹˜ì— ê¸°ë¬¼ì´ ìˆëŠ”ì§€ í™•ì¸
        function hasPieceAt(index) {
            const square = document.querySelector(`[data-index="${index}"]`);
            return square && square.dataset.piece;
        }

        // íƒ€ì´ë¨¸ ì‹œì‘ (ì•„ë‘ì´ë…¸ ë°ì´í„°ë§Œ ì‚¬ìš©)
        function startTimer() {
            console.log('íƒ€ì´ë¨¸ ì‹œì‘ - ì•„ë‘ì´ë…¸ ë°ì´í„° ëŒ€ê¸° ì¤‘');
            // ì•„ë‘ì´ë…¸ì—ì„œ íƒ€ì´ë¨¸ ë°ì´í„°ë¥¼ ë³´ë‚´ì£¼ë¯€ë¡œ ìë™ ê°ì†Œ ë¡œì§ ë¶ˆí•„ìš”
        }

        // íƒ€ì´ë¨¸ ì •ì§€
        function stopTimer() {
            console.log('íƒ€ì´ë¨¸ ì •ì§€');
            // ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ëŠ” ê³„ì† ì‘ë™
        }

        // íƒ€ì´ë¨¸ ë¦¬ì…‹ (ì•„ë‘ì´ë…¸ì—ì„œ ì´ˆê¸°í™”)
        function resetTimer() {
            console.log('íƒ€ì´ë¨¸ ë¦¬ì…‹ - ì•„ë‘ì´ë…¸ì—ì„œ ì´ˆê¸°í™”ë¨');
            // ì•„ë‘ì´ë…¸ì—ì„œ 10ë¶„(600ì´ˆ)ìœ¼ë¡œ ì´ˆê¸°í™”
            whiteTimer = 600;
            blackTimer = 600;
            updateTimerDisplay();
        }

        // ì‹œê°„ ì´ˆê³¼ ì²˜ë¦¬ (ì•„ë‘ì´ë…¸ì—ì„œ ì²˜ë¦¬)
        function handleTimeOut() {
            // ì•„ë‘ì´ë…¸ì—ì„œ ì‹œê°„ ì´ˆê³¼ë¥¼ ê°ì§€í•˜ê³  ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ë¡œê·¸ë§Œ
            console.log('ì•„ë‘ì´ë…¸ì—ì„œ ì‹œê°„ ì´ˆê³¼ ì²˜ë¦¬ë¨');
        }

        // ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ ì‹œì‘
        function startArduinoTimer() {
            console.log('ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ ì‹œì‘ ìš”ì²­');

            // WebSocketì„ í†µí•´ ì•„ë‘ì´ë…¸ì— íƒ€ì´ë¨¸ ì‹œì‘ ì‹ í˜¸ ì „ì†¡
            if (websocket && websocket.connected) {
                websocket.emit('start_arduino_timer', {
                    action: 'start',
                    time: 600, // 10ë¶„
                    message: 'START_TIMER'
                });
                console.log('ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ ì‹œì‘ ì‹ í˜¸ ì „ì†¡ë¨');

                // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                const btn = document.getElementById('arduinoTimerBtn');
                btn.textContent = 'íƒ€ì´ë¨¸ ì‹¤í–‰ ì¤‘...';
                btn.disabled = true;
                btn.style.background = '#28a745';
            } else {
                console.log('WebSocket ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤');
                alert('WebSocket ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”');
            }
        }

        // ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ ì •ì§€
        function stopArduinoTimer() {
            console.log('ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ ì •ì§€ ìš”ì²­');

            if (websocket && websocket.connected) {
                websocket.emit('stop_arduino_timer', {
                    action: 'stop',
                    message: 'STOP_TIMER'
                });
                console.log('ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ ì •ì§€ ì‹ í˜¸ ì „ì†¡ë¨');

                // ë²„íŠ¼ ìƒíƒœ ë³µì›
                const btn = document.getElementById('arduinoTimerBtn');
                btn.textContent = 'ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ ì‹œì‘';
                btn.disabled = false;
                btn.style.background = '';
            }
        }

        // ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ ë¦¬ì…‹
        function resetArduinoTimer() {
            console.log('ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ ë¦¬ì…‹ ìš”ì²­');

            if (websocket && websocket.connected) {
                websocket.emit('reset_arduino_timer', {
                    action: 'reset',
                    time: 600, // 10ë¶„ìœ¼ë¡œ ë¦¬ì…‹
                    message: 'RESET_TIMER'
                });
                console.log('ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ ë¦¬ì…‹ ì‹ í˜¸ ì „ì†¡ë¨');
            }
        }

        // íƒ€ì´ë¨¸ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateTimerDisplay() {
            const whiteTimerDiv = document.getElementById('whiteTimer');
            const blackTimerDiv = document.getElementById('blackTimer');

            // í°ìƒ‰ íƒ€ì´ë¨¸
            const whiteMinutes = Math.floor(whiteTimer / 60);
            const whiteSeconds = whiteTimer % 60;
            whiteTimerDiv.textContent = `${whiteMinutes}:${whiteSeconds.toString().padStart(2, '0')}`;

            // ê²€ì€ìƒ‰ íƒ€ì´ë¨¸
            const blackMinutes = Math.floor(blackTimer / 60);
            const blackSeconds = blackTimer % 60;
            blackTimerDiv.textContent = `${blackMinutes}:${blackSeconds.toString().padStart(2, '0')}`;

            // ê²½ê³  í‘œì‹œ
            whiteTimerDiv.className = 'timer-display';
            blackTimerDiv.className = 'timer-display';

            if (whiteTimer <= 60) {
                whiteTimerDiv.classList.add(whiteTimer <= 30 ? 'danger' : 'warning');
            }
            if (blackTimer <= 60) {
                blackTimerDiv.classList.add(blackTimer <= 30 ? 'danger' : 'warning');
            }

            // ì‹œê°„ ì´ˆê³¼ ì²´í¬ëŠ” startTimer í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬
        }



        // ìŠ¹ë¦¬ ê°€ëŠ¥ì„± ê³„ì‚°
        function calculateWinProbability() {
            const currentTurn = document.getElementById('currentTurn').textContent;
            const isWhiteTurn = currentTurn.includes('í°ìƒ‰');

            // ê¸°ë¬¼ ê°€ì¹˜ ê³„ì‚°
            const pieceValues = {
                'P': 1,   // í°
                'R': 5,   // ë£©
                'N': 3,   // ë‚˜ì´íŠ¸
                'B': 3,   // ë¹„ìˆ
                'Q': 9,   // í€¸
                'K': 0    // í‚¹ (ê²Œì„ì—ì„œ ìƒìœ¼ë©´ ë)
            };

            let whiteMaterial = 0;
            let blackMaterial = 0;
            let whitePieces = 0;
            let blackPieces = 0;

            // ëª¨ë“  ì¹¸ì„ ê²€ì‚¬í•˜ì—¬ ê¸°ë¬¼ ê°€ì¹˜ ê³„ì‚°
            const squares = document.querySelectorAll('.board-square');
            squares.forEach(square => {
                const piece = square.dataset.piece;
                const color = square.dataset.color;

                if (piece && pieceValues[piece] !== undefined) {
                    if (color === 'white') {
                        whiteMaterial += pieceValues[piece];
                        whitePieces++;
                    } else {
                        blackMaterial += pieceValues[piece];
                        blackPieces++;
                    }
                }
            });

            // ì²´í¬ë©”ì´íŠ¸ ìƒí™© í™•ì¸
            const gameStatus = document.getElementById('gameStatus').textContent;
            if (gameStatus.includes('ê²Œì„ ì¢…ë£Œ')) {
                const gameResult = document.getElementById('gameResult');
                if (gameResult) {
                    if (gameResult.textContent.includes('í°ìƒ‰ ìŠ¹ë¦¬')) {
                        return { white: 100, black: 0, message: 'í°ìƒ‰ ìŠ¹ë¦¬!' };
                    } else if (gameResult.textContent.includes('ê²€ì€ìƒ‰ ìŠ¹ë¦¬')) {
                        return { white: 0, black: 100, message: 'ê²€ì€ìƒ‰ ìŠ¹ë¦¬!' };
                    } else {
                        return { white: 50, black: 50, message: 'ë¬´ìŠ¹ë¶€!' };
                    }
                }
            }

            // ì²´í¬ ìƒí™© í™•ì¸
            const isCheck = document.querySelector('.board-square.legal-move') !== null;

            // ê¸°ë³¸ ìŠ¹ë¦¬ ê°€ëŠ¥ì„± ê³„ì‚° (ê¸°ë¬¼ ê°€ì¹˜ ê¸°ë°˜)
            let whiteWinChance = 50;
            let blackWinChance = 50;

            if (whiteMaterial > blackMaterial) {
                const materialAdvantage = (whiteMaterial - blackMaterial) / 9; // ìµœëŒ€ ê¸°ë¬¼ ê°€ì¹˜ë¡œ ì •ê·œí™”
                whiteWinChance = 50 + (materialAdvantage * 30); // ìµœëŒ€ 80%
                blackWinChance = 100 - whiteWinChance;
            } else if (blackMaterial > whiteMaterial) {
                const materialAdvantage = (blackMaterial - whiteMaterial) / 9;
                blackWinChance = 50 + (materialAdvantage * 30);
                whiteWinChance = 100 - blackWinChance;
            }

            // ê¸°ë¬¼ ìˆ˜ ê³ ë ¤
            if (whitePieces > blackPieces) {
                whiteWinChance += 5;
                blackWinChance -= 5;
            } else if (blackPieces > whitePieces) {
                blackWinChance += 5;
                whiteWinChance -= 5;
            }

            // ì²´í¬ ìƒí™© ê³ ë ¤
            if (isCheck) {
                if (isWhiteTurn) {
                    blackWinChance += 10;
                    whiteWinChance -= 10;
                } else {
                    whiteWinChance += 10;
                    blackWinChance -= 10;
                }
            }

            // í™•ë¥  ë²”ìœ„ ì œí•œ
            whiteWinChance = Math.max(0, Math.min(100, whiteWinChance));
            blackWinChance = Math.max(0, Math.min(100, blackWinChance));

            // ë©”ì‹œì§€ ìƒì„±
            let message = '';
            if (whiteWinChance > 60) {
                message = 'í°ìƒ‰ì´ ìœ ë¦¬í•©ë‹ˆë‹¤';
            } else if (blackWinChance > 60) {
                message = 'ê²€ì€ìƒ‰ì´ ìœ ë¦¬í•©ë‹ˆë‹¤';
            } else {
                message = 'ê· í˜•ì¡íŒ ìƒí™©ì…ë‹ˆë‹¤';
            }

            return {
                white: Math.round(whiteWinChance),
                black: Math.round(blackWinChance),
                message: message,
                whiteMaterial: whiteMaterial,
                blackMaterial: blackMaterial
            };
        }

        // ìŠ¹ë¦¬ ê°€ëŠ¥ì„± í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateWinProbability() {
            const probability = calculateWinProbability();
            const winProbDiv = document.getElementById('winProbability');

            if (probability.message.includes('ìŠ¹ë¦¬') || probability.message.includes('ë¬´ìŠ¹ë¶€')) {
                winProbDiv.innerHTML = `
                    <div style="font-weight: bold; color: #e74c3c; margin-bottom: 10px;">
                        ${probability.message}
                    </div>
                `;
            } else {
                winProbDiv.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>í°ìƒ‰: ${probability.white}%</span>
                            <span>ê²€ì€ìƒ‰: ${probability.black}%</span>
                        </div>
                        <div style="background: #ecf0f1; height: 20px; border-radius: 10px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #3498db ${probability.white}%, #e74c3c ${probability.white}%); height: 100%; width: 100%;"></div>
                        </div>
                        <div style="text-align: center; margin-top: 5px; font-size: 12px; color: #7f8c8d;">
                            ${probability.message}
                        </div>
                        <div style="font-size: 11px; color: #95a5a6; margin-top: 5px;">
                            ê¸°ë¬¼ ê°€ì¹˜: í°ìƒ‰ ${probability.whiteMaterial}, ê²€ì€ìƒ‰ ${probability.blackMaterial}
                        </div>
                    </div>
                `;
            }
        }

        // FEN í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateFEN(fen) {
            const fenDisplay = document.getElementById('fenDisplay');
            if (fenDisplay) {
                fenDisplay.innerHTML = `<code>${fen}</code>`;
            }
        }

        // ì¢Œí‘œë¥¼ SANìœ¼ë¡œ ë³€í™˜
        function convertToSAN() {
            const coord1 = document.getElementById('fromCoord').value.toLowerCase();
            const coord2 = document.getElementById('toCoord').value.toLowerCase();
            const promotion = document.getElementById('promotionPiece').value;
            const resultDiv = document.getElementById('sanResult');

            if (!coord1 || !coord2) {
                resultDiv.innerHTML = '<span class="error">ì‹œì‘ ìœ„ì¹˜ì™€ ë„ì°© ìœ„ì¹˜ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.</span>';
                resultDiv.className = 'san-result error';
                return;
            }

            // ì¢Œí‘œ í˜•ì‹ ê²€ì¦
            const coordPattern = /^[a-h][1-8]$/;
            if (!coordPattern.test(coord1) || !coordPattern.test(coord2)) {
                resultDiv.innerHTML = '<span class="error">ì˜¬ë°”ë¥¸ ì¢Œí‘œ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: e2, a1)</span>';
                resultDiv.className = 'san-result error';
                return;
            }

            // API í˜¸ì¶œ
            fetch('/coordinates_to_san', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    coord1: coord1,
                    coord2: coord2,
                    promotion: promotion
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let resultHTML = `
                        <div class="success">
                            <strong>SAN: ${data.san}</strong><br>
                            <small>UCI: ${data.uci}</small><br>
                            <small>ê¸°ë¬¼: ${data.piece} (${data.analysis.piece_color === 'white' ? 'í°ìƒ‰' : 'ê²€ì€ìƒ‰'})</small><br>
                            <small>ì´ë™ ìˆ˜: ${data.analysis.move_number}</small>
                    `;

                        if (data.is_capture) {
                            resultHTML += '<br><small>ğŸ¯ ê¸°ë¬¼ ì¡ê¸°</small>';
                        }
                        if (data.is_check) {
                            resultHTML += '<br><small>âš¡ ì²´í¬</small>';
                        }
                        if (data.is_checkmate) {
                            resultHTML += '<br><small>â™” ì²´í¬ë©”ì´íŠ¸!</small>';
                        }

                        resultHTML += '</div>';
                        resultDiv.innerHTML = resultHTML;
                        resultDiv.className = 'san-result success';
                    } else {
                        resultDiv.innerHTML = `<span class="error">ì˜¤ë¥˜: ${data.error}</span>`;
                        resultDiv.className = 'san-result error';
                    }
                })
                .catch(error => {
                    resultDiv.innerHTML = `<span class="error">ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error}</span>`;
                    resultDiv.className = 'san-result error';
                });
        }

        // Enter í‚¤ë¡œ SAN ë³€í™˜
        document.addEventListener('DOMContentLoaded', function () {
            const fromCoord = document.getElementById('fromCoord');
            const toCoord = document.getElementById('toCoord');

            if (fromCoord && toCoord) {
                fromCoord.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        toCoord.focus();
                    }
                });

                toCoord.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        convertToSAN();
                    }
                });
            }
        });

        // í•©ë²•ì ì¸ ì´ë™ í‘œì‹œ ì œê±°
        function clearLegalMoves() {
            const squares = document.querySelectorAll('.board-square');
            squares.forEach(square => {
                square.classList.remove('legal-move');
            });
        }



        // ìˆ˜ ë‘ê¸°
        function makeMove(fromSquare, toSquare) {
            fetch('/make_move', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    from_square: fromSquare,
                    to_square: toSquare
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateGameState(data.board_state);
                        updateBoard(data.board_state.fen);

                        // ìˆ˜ë¥¼ ë‘” í›„ íƒ€ì´ë¨¸ ì¬ì‹œì‘ (í˜„ì¬ ì°¨ë¡€ì— ë§ì¶°ì„œ)
                        startTimer();
                    } else {
                        alert(data.error || 'ì˜ëª»ëœ ìˆ˜ì…ë‹ˆë‹¤.');
                    }
                })
                .catch(error => {
                    console.error('ìˆ˜ ë‘ê¸° ì˜¤ë¥˜:', error);
                    alert('ìˆ˜ë¥¼ ë‘˜ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                });
        }

        // ê²Œì„ ë¦¬ì…‹
        function resetGame() {
            fetch('/reset_game')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentGame = null;
                        selectedSquare = null;
                        document.getElementById('gameSetup').classList.remove('hidden');
                        document.getElementById('gameBoard').classList.add('hidden');
                        clearSelection();

                        // ê²Œì„ ì¢…ë£Œ í‘œì‹œ ìˆ¨ê¸°ê¸°
                        document.getElementById('gameOver').classList.add('hidden');

                        // ê²Œì„ ìƒíƒœ ì´ˆê¸°í™”
                        document.getElementById('gameStatus').textContent = 'ê²Œì„ ì¤€ë¹„ ì¤‘';
                        document.getElementById('gameStatus').style.color = '#495057';
                        document.getElementById('gameStatus').style.fontWeight = 'normal';
                        document.getElementById('currentTurn').textContent = '';

                        // íƒ€ì´ë¨¸ ë¦¬ì…‹ ë° ì •ì§€
                        stopTimer();
                        resetTimer();

                        // ì•„ë‘ì´ë…¸ íƒ€ì´ë¨¸ë„ ì •ì§€
                        stopArduinoTimer();
                    }
                })
                .catch(error => {
                    console.error('ê²Œì„ ë¦¬ì…‹ ì˜¤ë¥˜:', error);
                });
        }

        // ë¬´ë¥´ê¸° (ê°„ë‹¨í•œ êµ¬í˜„)
        function undoMove() {
            alert('ë¬´ë¥´ê¸° ê¸°ëŠ¥ì€ í˜„ì¬ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function () {
            console.log('í˜ì´ì§€ ë¡œë“œë¨, ì²´ìŠ¤ë³´ë“œ ì´ˆê¸°í™” ì‹œì‘');
            initializeBoard();
            console.log('ì²´ìŠ¤ë³´ë“œ ì´ˆê¸°í™” ì™„ë£Œ');

            // WebSocket ì—°ê²° ì‹œì‘
            connectWebSocket();
        });
    </script>
</body>

</html>